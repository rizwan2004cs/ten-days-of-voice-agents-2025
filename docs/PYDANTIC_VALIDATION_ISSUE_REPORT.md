# Pydantic Validation Error Issue Report

## Executive Summary

The e-commerce voice agent is experiencing a persistent Pydantic validation error when the LLM calls the `browse_products` function tool with partial parameters. The error occurs **before** the function is executed, during LiveKit Agents' internal Pydantic model validation.

## Issue Description

### Error Message
```
ERROR livekit.agents tried to call AI function `browse_products` with invalid arguments
pydantic_core._pydantic_core.ValidationError: 3-4 validation errors for BrowseProductsArgs
  category
    Field required [type=missing, input_value={'search_term': 'cameras', 'max_price': 10000}, input_type=dict]
  min_price
    Field required [type=missing, input_value={'search_term': 'cameras', 'max_price': 10000}, input_type=dict]
  sort_by
    Field required [type=missing, input_value={'search_term': 'cameras', 'max_price': 10000}, input_type=dict]
```

### User Experience
- User says: "show me cameras under 10000"
- LLM calls: `browse_products(search_term="cameras", max_price=10000)`
- **Error occurs** before function execution
- Agent responds: "I'm sorry, I encountered an error" or "An internal error occurred"

### Root Cause
The `@function_tool` decorator from `livekit.agents` automatically generates a Pydantic model from the function signature. This generated model is **incorrectly treating optional parameters as required**, even when they have default values.

## System Architecture

### Technology Stack
- **Framework**: LiveKit Agents v1.3.2
- **Python Version**: 3.12.12
- **Pydantic Version**: v2.12+ (inferred from error messages)
- **LLM**: Google Gemini 2.5 Flash
- **STT**: Deepgram Nova-3
- **TTS**: Murf AI

### Function Tool Generation Flow
```
1. @function_tool decorator inspects function signature
2. Uses inspect.signature() to extract parameters
3. Generates Pydantic model using create_model() or similar
4. LLM calls function with partial parameters
5. LiveKit validates arguments using model_validate()
6. ❌ Validation fails - treats optional fields as required
7. Error returned to LLM before function executes
```

### Current Function Signature
```python
@function_tool(description="Search and filter products from the catalog. All parameters are optional - provide only what you need.")
async def browse_products(
    self,
    context: RunContext,
    search_term: str = "",
    category: str = "",
    max_price: int = 0,
    min_price: int = 0,
    sort_by: str = "",
) -> str:
```

### File Structure
```
backend/
├── src/
│   ├── agent.py          # Main agent with @function_tool decorated methods
│   └── commerce.py       # Business logic layer (handles None correctly)
├── pyproject.toml        # Dependencies: livekit-agents[assemblyai,deepgram,google,silero,turn-detector]~=1.2
└── .env.local            # Environment variables
```

## Attempted Fixes

### Fix Attempt #1: Optional[T] = None Pattern
**Change**: Used Pydantic v2 recommended pattern
```python
search_term: Optional[str] = None,
category: Optional[str] = None,
max_price: Optional[int] = None,
min_price: Optional[int] = None,
sort_by: Optional[str] = None,
```
**Result**: ❌ Still fails - `function_tool` doesn't recognize `Optional[T] = None` as optional

### Fix Attempt #2: Concrete Defaults with Normalization
**Change**: Used concrete defaults and normalized inside function
```python
search_term: str = "",
category: str = "",
max_price: int = 0,
min_price: int = 0,
sort_by: str = "",
```
**Normalization Logic**:
```python
search_term = str(search_term).strip() if search_term else None
category = str(category).strip().lower() if category else None
max_price = int(max_price) if max_price and max_price > 0 else None
min_price = int(min_price) if min_price and min_price > 0 else None
sort_by = str(sort_by).strip() if sort_by else None
```
**Result**: ❌ Still fails - Pydantic model generation doesn't recognize defaults

### Fix Attempt #3: Removed llm.TypeInfo (Previous Issue)
**Change**: Removed `Annotated[Optional[T], llm.TypeInfo(...)]` because `llm.TypeInfo` doesn't exist
**Result**: ✅ Fixed AttributeError, but validation issue persists

## Technical Details

### How function_tool Works
1. **Decorator Application**: `@function_tool` wraps the function
2. **Signature Inspection**: Uses Python's `inspect.signature()` to get parameters
3. **Model Generation**: Creates a Pydantic model dynamically (likely using `create_model()`)
4. **Validation**: When LLM calls function, LiveKit validates using `model_validate()`

### Expected Behavior
When LLM calls with partial parameters:
```python
browse_products(search_term="cameras", max_price=10000)
```

Pydantic should:
- ✅ Accept `search_term` and `max_price`
- ✅ Use defaults for `category`, `min_price`, `sort_by`
- ✅ Pass validation

### Actual Behavior
Pydantic model generated by `function_tool`:
- ❌ Requires ALL fields (`category`, `min_price`, `sort_by`)
- ❌ Fails validation when fields are missing
- ❌ Error occurs in `livekit.agents.llm.utils.prepare_function_arguments()`

### Error Location
```
File: ...\livekit\agents\llm\utils.py, line 383, in prepare_function_arguments
    model = model_type.model_validate(args_dict)  # can raise ValidationError
```

### Comparison with Working Functions
Other functions in the same file work correctly:
```python
@function_tool(description="Place an order for a product")
async def place_order(
    self,
    context: RunContext,
    product_name_or_id: str,  # Required
    quantity: Optional[int] = 1,  # Optional with default - WORKS
) -> str:
```

**Key Difference**: `place_order` has only ONE optional parameter, while `browse_products` has FIVE optional parameters.

## Code Evidence

### Current Implementation (backend/src/agent.py:64-166)
```python
@function_tool(description="Search and filter products from the catalog. All parameters are optional - provide only what you need.")
async def browse_products(
    self,
    context: RunContext,
    search_term: str = "",
    category: str = "",
    max_price: int = 0,
    min_price: int = 0,
    sort_by: str = "",
) -> str:
    """
    Browse and filter products from the catalog.
    ALL PARAMETERS ARE OPTIONAL. You can provide any combination of:
    - search_term: Search by product name or keyword
    - category: Filter by category
    - max_price: Maximum price in INR
    - min_price: Minimum price in INR
    - sort_by: Sort option
    """
    try:
        # Normalize empty strings and 0 to None for optional parameters
        search_term = str(search_term).strip() if search_term else None
        category = str(category).strip().lower() if category else None
        max_price = int(max_price) if max_price and max_price > 0 else None
        min_price = int(min_price) if min_price and min_price > 0 else None
        sort_by = str(sort_by).strip() if sort_by else None
        
        # Call commerce layer (handles None correctly)
        filtered_products = get_products(
            search_term=search_term,
            category=category,
            max_price=max_price,
            min_price=min_price,
            sort_by=sort_by
        )
        # ... rest of function
    except Exception as e:
        logger.error(f"❌ ERROR in browse_products: {e}", exc_info=True)
        return f"I encountered an error while searching for products: {str(e)}"
```

### Commerce Layer (backend/src/commerce.py:314-320)
```python
def get_products(
    category: Optional[str] = None,
    max_price: Optional[int] = None,
    min_price: Optional[int] = None,
    search_term: Optional[str] = None,
    sort_by: Optional[str] = None,
) -> list[dict]:
    # This function correctly handles None values
    # The issue is NOT here - it's in the Pydantic validation before this is called
```

## Dependencies

### pyproject.toml
```toml
[project]
dependencies = [
    "livekit-agents[assemblyai,deepgram,google,silero,turn-detector]~=1.2",
    # ... other dependencies
]
```

### Key Versions
- `livekit-agents`: ~1.2 (actual: 1.3.2 from logs)
- `pydantic`: v2.12+ (inferred from error format)
- Python: 3.12.12

## Error Traceback (Full)
```
ERROR livekit.agents tried to call AI function `browse_products` with invalid arguments
Traceback (most recent call last):
  File "...\livekit\agents\voice\generation.py", line 454, in _execute_tools_task
    fnc_args, fnc_kwargs = llm_utils.prepare_function_arguments(...)
  File "...\livekit\agents\llm\utils.py", line 383, in prepare_function_arguments
    model = model_type.model_validate(args_dict)  # can raise ValidationError
  File "...\pydantic\main.py", line 716, in model_validate
    return cls.__pydantic_validator__.validate_python(...)
pydantic_core._pydantic_core.ValidationError: 3 validation errors for BrowseProductsArgs
  category
    Field required [type=missing, input_value={'search_term': 'cameras', 'max_price': 10000}, input_type=dict]
  min_price
    Field required [type=missing, input_value={'search_term': 'cameras', 'max_price': 10000}, input_type=dict]
  sort_by
    Field required [type=missing, input_value={'search_term': 'cameras', 'max_price': 10000}, input_type=dict]
```

## Hypothesis

The `function_tool` decorator's Pydantic model generation has a bug or limitation:
1. **Multiple Optional Parameters**: Functions with many optional parameters may not be handled correctly
2. **Default Value Recognition**: The model generation may not correctly recognize default values from function signatures
3. **Pydantic v2 Compatibility**: There may be a compatibility issue between LiveKit's model generation and Pydantic v2's stricter validation

## Potential Solutions to Investigate

### Solution 1: Manual Pydantic Model
Create an explicit Pydantic model and pass it to `function_tool` (if supported):
```python
from pydantic import BaseModel, Field

class BrowseProductsArgs(BaseModel):
    search_term: str = Field(default="", description="Search term")
    category: str = Field(default="", description="Category")
    max_price: int = Field(default=0, description="Max price")
    min_price: int = Field(default=0, description="Min price")
    sort_by: str = Field(default="", description="Sort option")
```

### Solution 2: Split into Multiple Functions
Break `browse_products` into smaller functions with fewer optional parameters:
- `search_products(search_term: str)`
- `filter_by_price(max_price: int, min_price: int = 0)`
- `sort_products(sort_by: str)`

### Solution 3: Use **kwargs Pattern
If `function_tool` supports it:
```python
async def browse_products(self, context: RunContext, **kwargs) -> str:
    search_term = kwargs.get("search_term", "")
    # ... handle all parameters manually
```

### Solution 4: Patch LiveKit's Model Generation
Intercept the model creation and patch it after `function_tool` is applied (advanced).

### Solution 5: Update LiveKit Agents
Check if a newer version of `livekit-agents` fixes this issue.

### Solution 6: Use Required Parameters with Empty String Handling
Make all parameters required but handle empty strings:
```python
async def browse_products(
    self,
    context: RunContext,
    search_term: str,  # Required but can be ""
    category: str,     # Required but can be ""
    max_price: int,    # Required but can be 0
    min_price: int,    # Required but can be 0
    sort_by: str,      # Required but can be ""
) -> str:
```

## Testing

### Test Case
**Input**: "show me cameras under 10000"
**Expected LLM Call**: `browse_products(search_term="cameras", max_price=10000)`
**Expected Behavior**: Function executes successfully
**Actual Behavior**: Pydantic validation error before function execution

### Reproduction Steps
1. Start LiveKit server: `livekit-server --dev`
2. Start backend agent: `cd backend && uv run python src/agent.py dev`
3. Start frontend: `cd frontend && npm run dev`
4. Connect to voice agent
5. Say: "show me cameras under 10000"
6. Observe error in backend logs

## Additional Context

### Why This Matters
- The `browse_products` function is the **core functionality** of the e-commerce agent
- Users expect to filter products by various criteria
- The error prevents the agent from functioning correctly

### Related Functions
Other functions with optional parameters that **work correctly**:
- `place_order(product_name_or_id: str, quantity: Optional[int] = 1)` ✅
- `get_order_history(limit: Optional[int] = 5)` ✅
- `add_to_cart(product_name_or_id: str, quantity: Optional[int] = 1)` ✅

**Pattern**: Functions with 1-2 optional parameters work, but `browse_products` with 5 optional parameters fails.

## Questions for Other LLMs/AI Assistants

1. **How does LiveKit Agents' `function_tool` decorator generate Pydantic models from function signatures?**
2. **Why would a Pydantic model generated from a function with default values treat those fields as required?**
3. **Is there a known bug in LiveKit Agents v1.3.2 regarding optional parameters in function tools?**
4. **How can I manually specify a Pydantic model for a `function_tool` instead of auto-generation?**
5. **What's the best workaround for functions with many optional parameters in LiveKit Agents?**
6. **Is there a way to patch or override the Pydantic model generation in `function_tool`?**
7. **Should I split `browse_products` into multiple smaller functions to avoid this issue?**
8. **Are there any LiveKit Agents configuration options that affect Pydantic model generation?**

## Files Modified

1. **backend/src/agent.py** (lines 64-166)
   - Function signature changed multiple times
   - Normalization logic updated
   - Error handling added

## Next Steps

1. **Check LiveKit Agents GitHub Issues**: Search for similar problems
2. **Test with Latest Version**: Try updating `livekit-agents` to latest version
3. **Contact LiveKit Support**: Report this as a potential bug
4. **Implement Workaround**: Use one of the potential solutions above
5. **Consider Alternative**: Split function or use different pattern

---

**Document Version**: 1.0
**Last Updated**: 2025-11-30
**Status**: Issue unresolved, multiple fix attempts failed

